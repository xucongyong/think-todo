<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TT Mission Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { gray: { 900: '#05070a', 800: '#0f1219', 700: '#1f2533' } }, fontFamily: { mono: ['Fira Code', 'Menlo', 'monospace'] } } } }
    </script>
    <style>
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }
        [x-cloak] { display: none !important; }
        .active-row { background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; }
        .neural-bg { background: radial-gradient(circle at top right, rgba(29, 78, 216, 0.05), transparent); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-mono h-screen overflow-hidden flex flex-col" x-data="app()">

    <!-- Top Navigation -->
    <nav class="h-14 border-b border-gray-800 bg-black/50 backdrop-blur-md flex items-center justify-between px-6 z-30 shadow-2xl">
        <div class="flex items-center space-x-4">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-black text-white shadow-[0_0_15px_rgba(37,99,235,0.4)]">T</div>
            <h1 class="tracking-[0.4em] font-black text-gray-400 text-xs">MISSION <span class="text-blue-500">DECK</span></h1>
        </div>
        <div class="flex items-center space-x-8">
            <div class="flex space-x-4 text-[10px]">
                <div class="text-right">
                    <p class="text-gray-600 font-bold uppercase">Economy</p>
                    <p class="text-green-500 font-black" x-text="'$' + stats.total_cost.toFixed(4)"></p>
                </div>
                <div class="text-right border-l border-gray-800 pl-4">
                    <p class="text-gray-600 font-bold uppercase">Success Rate</p>
                    <p class="text-blue-400 font-black" x-text="Math.round((stats.tasks_done/stats.tasks_total)*100 || 0) + '%'"></p>
                </div>
            </div>
            <button @click="showAddTask = true" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-[10px] font-black tracking-widest transition uppercase shadow-lg shadow-blue-900/40 border border-blue-400/20">+ New Task</button>
        </div>
    </nav>

    <main class="flex-1 flex overflow-hidden">
        
        <!-- Left: Task Master List -->
        <div class="w-1/3 flex flex-col border-r border-gray-800 bg-gray-900/50">
            <div class="p-4 border-b border-gray-800 bg-black/20 flex justify-between items-center">
                <span class="text-[9px] font-black text-gray-500 tracking-widest uppercase">Operational Backlog</span>
                <span class="text-[9px] text-gray-600" x-text="tasks.length + ' Total Missions'"></span>
            </div>
            <div class="flex-1 overflow-y-auto">
                <template x-for="task in tasks" :key="task.id">
                    <div @click="selectTask(task)" 
                         class="p-4 border-b border-gray-800/50 cursor-pointer transition relative group"
                         :class="{ 'active-row bg-gray-800/40': selectedTask && selectedTask.id === task.id, 'hover:bg-gray-800/20': !selectedTask || selectedTask.id !== task.id }">
                        
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-black" :class="task.status === 'in_progress' ? 'text-blue-400' : 'text-gray-500'" x-text="task.id"></span>
                            <div class="flex items-center space-x-2">
                                <span class="text-[8px] px-1.5 py-0.5 rounded font-black tracking-tighter"
                                      :class="{ 'bg-yellow-900/30 text-yellow-500': task.status === 'open', 'bg-blue-900/30 text-blue-400': task.status === 'in_progress', 'bg-green-900/30 text-green-500': task.status === 'closed' }"
                                      x-text="task.status.toUpperCase()"></span>
                                <button @click.stop="deleteTask(task.id)" class="opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-500 transition px-1">&times;</button>
                            </div>
                        </div>
                        <h4 class="text-[11px] font-medium text-gray-300 group-hover:text-white transition line-clamp-2" x-text="task.title"></h4>
                        
                        <div x-show="task.status === 'in_progress'" class="mt-2 flex items-center space-x-2">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_5px_#22c55e]"></span>
                            <span class="text-[9px] text-gray-500 font-bold" x-text="task.assignee"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Right: Focused Command Center -->
        <div class="flex-1 flex flex-col bg-gray-900 neural-bg relative">
            
            <template x-if="!selectedTask">
                <div class="flex-1 flex flex-col items-center justify-center text-gray-700">
                    <div class="w-16 h-16 border-2 border-gray-800 rounded-full flex items-center justify-center mb-4 opacity-20">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <p class="text-[10px] font-black tracking-[0.5em] uppercase">Select a mission to bridge link</p>
                </div>
            </template>

            <template x-if="selectedTask">
                <div class="flex-1 flex flex-col overflow-hidden">
                    <!-- Detail Header -->
                    <div class="p-6 border-b border-gray-800 bg-black/20">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-2xl font-black text-white tracking-tighter" x-text="selectedTask.id"></h2>
                                <p class="text-xs text-gray-400 mt-1 max-w-2xl" x-text="selectedTask.title"></p>
                            </div>
                            <div class="flex space-x-2">
                                <button @click="deleteTask(selectedTask.id)" class="bg-red-600/20 hover:bg-red-600 text-red-500 hover:text-white border border-red-600/50 text-[10px] font-black px-4 py-2 rounded transition uppercase tracking-widest shadow-lg shadow-red-900/20">Delete</button>
                            </div>
                        </div>

                        <!-- Status Context Action Bar -->
                        <div class="flex items-center space-x-4 bg-gray-800/30 p-3 rounded-lg border border-gray-700/50">
                            <!-- OPEN STATE: Start Controls -->
                            <template x-if="selectedTask.status === 'open'">
                                <div class="flex-1 flex items-center justify-between">
                                    <div class="flex space-x-4">
                                        <div>
                                            <label class="text-[8px] text-gray-500 font-bold uppercase block mb-1">Assigned Unit</label>
                                            <input x-model="startData.agent_name" class="bg-black border border-gray-700 rounded px-2 py-1 text-[10px] w-32 focus:border-blue-500 outline-none">
                                        </div>
                                        <div>
                                            <label class="text-[8px] text-gray-500 font-bold uppercase block mb-1">Intelligence</label>
                                            <select x-model="startData.engine" class="bg-black border border-gray-700 rounded px-2 py-1 text-[10px] w-32 outline-none">
                                                <option value="gemini">Gemini YOLO</option>
                                                <option value="opencode">OpenCode</option>
                                                <option value="claude">Claude</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button @click="submitStart()" class="bg-blue-600 hover:bg-blue-500 text-white font-black text-[10px] px-6 py-2 rounded transition shadow-lg shadow-blue-900/40">DEPLOY AGENT</button>
                                </div>
                            </template>

                            <!-- IN PROGRESS STATE: Live Controls -->
                            <template x-if="selectedTask.status === 'in_progress'">
                                <div class="flex-1 flex items-center justify-between">
                                    <div class="flex items-center space-x-6">
                                        <div class="flex flex-col">
                                            <span class="text-[8px] text-gray-500 font-bold uppercase block">Intelligence</span>
                                            <span class="text-[10px] font-black text-blue-400" x-text="selectedTask.engine.toUpperCase()"></span>
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="text-[8px] text-gray-500 font-bold uppercase block">Deployment</span>
                                            <span class="text-[10px] font-black text-green-400" x-text="selectedTask.assignee"></span>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button @click="nudgeAgent()" class="bg-yellow-600 hover:bg-yellow-500 text-black font-black text-[10px] px-4 py-2 rounded transition shadow-lg shadow-yellow-900/20">NUDGE</button>
                                        <button @click="markAsDone(selectedTask.id)" class="bg-green-600 hover:bg-green-500 text-white font-black text-[10px] px-4 py-2 rounded transition shadow-lg shadow-green-900/20">STOP & DONE</button>
                                    </div>
                                </div>
                            </template>

                            <!-- CLOSED STATE -->
                            <template x-if="selectedTask.status === 'closed'">
                                <div class="flex-1 flex items-center space-x-4 text-green-500">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"></path></svg>
                                    <span class="text-[10px] font-black tracking-widest uppercase">Mission Successfully Archived</span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Telemetry Tabs Section -->
                    <div class="flex-1 flex flex-col min-h-0 bg-black/40">
                        <div class="flex border-b border-gray-800 bg-black/20 px-4">
                            <button @click="activeTab = 'logs'" :class="activeTab === 'logs' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-gray-500'" class="px-4 py-3 text-[10px] font-black tracking-widest uppercase transition">Logs</button>
                            <button @click="activeTab = 'prompt'; fetchPrompt()" :class="activeTab === 'prompt' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-gray-500'" class="px-4 py-3 text-[10px] font-black tracking-widest uppercase transition">Prompt</button>
                            <button @click="activeTab = 'files'; fetchFiles()" :class="activeTab === 'files' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-gray-500'" class="px-4 py-3 text-[10px] font-black tracking-widest uppercase transition">Files</button>
                            <button @click="activeTab = 'history'; fetchHistory()" :class="activeTab === 'history' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-gray-500'" class="px-4 py-3 text-[10px] font-black tracking-widest uppercase transition">History</button>
                        </div>

                        <div class="flex-1 overflow-y-auto p-6 font-mono text-[11px] leading-relaxed">
                            <!-- Logs Tab -->
                            <div x-show="activeTab === 'logs'">
                                <template x-if="selectedTask.status === 'open'">
                                    <p class="text-gray-600 italic">Waiting for deployment...</p>
                                </template>
                                <pre class="text-green-500/80 whitespace-pre-wrap" x-text="logsContent"></pre>
                            </div>

                            <!-- Prompt Tab -->
                            <div x-show="activeTab === 'prompt'" x-cloak>
                                <pre class="text-blue-300/70 whitespace-pre-wrap" x-text="promptContent"></pre>
                            </div>

                            <!-- Files Tab -->
                            <div x-show="activeTab === 'files'" x-cloak>
                                <div class="grid grid-cols-2 gap-2">
                                    <template x-for="file in agentFiles" :key="file">
                                        <div class="bg-gray-800/50 border border-gray-700 p-2 rounded flex items-center space-x-2 text-gray-300">
                                            <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                            <span x-text="file"></span>
                                        </div>
                                    </template>
                                    <div x-show="agentFiles.length === 0" class="col-span-2 text-gray-600 italic">No artifacts generated yet.</div>
                                </div>
                            </div>

                            <!-- History Tab -->
                            <div x-show="activeTab === 'history'" x-cloak class="space-y-4">
                                <template x-for="h in taskHistory" :key="h.timestamp + h.action">
                                    <div class="flex items-start space-x-3 border-l border-gray-800 pl-4 relative">
                                        <div class="absolute -left-1.5 top-1.5 w-3 h-3 bg-gray-800 border border-gray-700 rounded-full"></div>
                                        <div>
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="text-[9px] text-gray-500 font-bold" x-text="formatTime(h.timestamp)"></span>
                                                <span class="text-[10px] text-purple-400 font-black uppercase" x-text="h.actor"></span>
                                            </div>
                                            <p class="text-gray-300">
                                                <span class="text-yellow-500 italic" x-text="h.action"></span>
                                                <span class="text-gray-500"> on </span>
                                                <span class="text-blue-400" x-text="h.target"></span>
                                            </p>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="taskHistory.length === 0" class="text-gray-600 italic text-center py-8">No history recorded for this mission.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <!-- Modal: Simple Add Task -->
    <div x-show="showAddTask" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4" x-cloak>
        <div class="bg-gray-800 border border-gray-700 p-6 rounded-xl w-96 shadow-2xl">
            <h2 class="text-lg font-black mb-4 text-blue-500 tracking-tighter uppercase">Initiate Mission</h2>
            <div class="space-y-4">
                <input x-model="newTask.id" class="w-full bg-black border border-gray-700 rounded p-3 text-xs outline-none focus:border-blue-500" placeholder="Code (e.g. T101)">
                <textarea x-model="newTask.title" class="w-full bg-black border border-gray-700 rounded p-3 text-xs h-32 outline-none focus:border-blue-500" placeholder="Operational Objectives..."></textarea>
                <div class="flex justify-end space-x-3 pt-2">
                    <button @click="showAddTask = false" class="text-gray-500 text-[10px] font-bold uppercase">Abort</button>
                    <button @click="submitTask()" class="bg-blue-600 px-6 py-2 rounded text-[10px] font-black text-white uppercase tracking-widest">Register</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Viewer -->
    <div x-show="showPrompt" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/95 p-8" x-cloak>
        <div class="bg-gray-900 border border-blue-900/30 w-full h-full max-w-4xl rounded-xl flex flex-col p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
                <h2 class="text-xl font-black text-blue-500 tracking-tighter uppercase italic">AI Instructions</h2>
                <button @click="showPrompt = false" class="text-gray-500 hover:text-white transition text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto bg-black/50 p-6 rounded border border-gray-800">
                <pre class="text-gray-400 text-xs whitespace-pre-wrap leading-relaxed" x-text="promptContent"></pre>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                tasks: [], stats: { total_cost: 0, tasks_done: 0, tasks_total: 0 },
                selectedTask: null,
                logsContent: '',
                promptContent: '',
                agentFiles: [],
                taskHistory: [],
                activeTab: 'logs',
                showAddTask: false,
                newTask: { id: '', title: '' },
                startData: { agent_name: '', engine: 'gemini' },
                
                init() {
                    this.refresh();
                    setInterval(() => this.refresh(), 2000);
                    this.startData.agent_name = 'unit-' + Math.floor(1000 + Math.random() * 9000);
                },
                async refresh() {
                    try {
                        const res = await fetch('/api/dashboard');
                        const d = await res.json();
                        this.tasks = d.tasks;
                        this.stats = d.stats;
                        
                        if (this.selectedTask) {
                            const updated = this.tasks.find(t => t.id === this.selectedTask.id);
                            if (updated) this.selectedTask = updated;
                            if (this.selectedTask.status === 'in_progress' && this.activeTab === 'logs') this.fetchLogs();
                            if (this.selectedTask.status === 'in_progress' && this.activeTab === 'files') this.fetchFiles();
                        }
                    } catch (e) {}
                },
                selectTask(task) {
                    this.selectedTask = task;
                    this.logsContent = 'Linking...';
                    this.activeTab = 'logs';
                    this.startData.task_id = task.id;
                    if (task.status === 'in_progress') this.fetchLogs();
                    else this.logsContent = '';
                },
                async fetchLogs() {
                    if (!this.selectedTask || !this.selectedTask.assignee) return;
                    try {
                        const res = await fetch(`/api/logs/${this.selectedTask.id}/${this.selectedTask.assignee}`);
                        const d = await res.json();
                        this.logsContent = d.content;
                    } catch (e) { this.logsContent = 'Telemetry lost...'; }
                },
                async fetchPrompt() {
                    const res = await fetch(`/api/prompts/worker`);
                    const d = await res.json();
                    this.promptContent = d.content;
                },
                async fetchFiles() {
                    if (!this.selectedTask || !this.selectedTask.assignee) return;
                    const res = await fetch(`/api/agents/${this.selectedTask.assignee}/files`);
                    const d = await res.json();
                    this.agentFiles = d.files;
                },
                async fetchHistory() {
                    if (!this.selectedTask) return;
                    const res = await fetch(`/api/tasks/${this.selectedTask.id}/history`);
                    const d = await res.json();
                    this.taskHistory = d.history;
                },
                async submitTask() {
                    if(!this.newTask.id || !this.newTask.title) return;
                    await fetch('/api/tasks', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.newTask) });
                    this.showAddTask = false; this.newTask = { id: '', title: '' }; this.refresh();
                },
                async submitStart() {
                    await fetch('/api/start', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
                        task_id: this.selectedTask.id,
                        agent_name: this.startData.agent_name,
                        engine: this.startData.engine
                    }) });
                    this.refresh();
                },
                async markAsDone(tid) {
                    if(!confirm("DECOMMISSION UNIT?")) return;
                    await fetch(`/api/done/${tid}`, { method: 'POST' });
                    this.refresh();
                },
                async deleteTask(tid) {
                    if(!confirm("PURGE MISSION?")) return;
                    await fetch(`/api/tasks/${tid}`, { method: 'DELETE' });
                    this.selectedTask = null; this.refresh();
                },
                async nudgeAgent() {
                    const msg = prompt("COMMAND SIGNAL:");
                    if(!msg) return;
                    await fetch('/api/nudge', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ agent_name: this.selectedTask.assignee, message: msg }) });
                },
                closeModals() { 
                    this.showAddTask = false; 
                },
                formatTime(ts) { 
                    const date = new Date(ts * 1000);
                    return date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0') + ':' + date.getSeconds().toString().padStart(2, '0');
                }
            }
        }
    </script>
</body>
</html>
