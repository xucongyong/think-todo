<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TT Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { gray: { 900: '#0a0f1e', 800: '#161b2d', 700: '#2d334a' } }, fontFamily: { mono: ['Fira Code', 'Menlo', 'monospace'] } } } }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0f1e; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        [x-cloak] { display: none !important; }
        .glass { background: rgba(22, 27, 45, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-mono h-screen overflow-hidden flex flex-col" x-data="app()" @keydown.escape="closeModals()">

    <!-- Modals -->
    <!-- 1. Agent Detail / Logs -->
    <div x-show="showAgentDetail" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" x-cloak>
        <div class="bg-gray-800 border border-gray-700 w-full h-full max-w-6xl rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50">
                <div class="flex items-center space-x-4">
                    <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                    <h2 class="text-lg font-bold text-green-400" x-text="'AGENT: ' + activeAgent.name"></h2>
                    <span class="text-gray-500">|</span>
                    <span class="text-blue-400 text-sm" x-text="'TASK ' + activeAgent.taskId"></span>
                </div>
                <button @click="showAgentDetail = false" class="text-gray-400 hover:text-white transition">&times; CLOSE</button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-64 bg-gray-900 border-r border-gray-700 p-4 space-y-4 text-center">
                    <button @click="nudgeAgent()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white py-2 rounded font-bold transition text-xs">NUDGE AGENT</button>
                    <button @click="markAsDone(activeAgent.taskId)" class="w-full bg-green-700 hover:bg-green-600 text-white py-2 rounded font-bold transition text-xs">MARK DONE</button>
                    <div class="pt-4 border-t border-gray-800 flex flex-col space-y-2">
                        <button @click="viewPrompt('worker')" class="text-[10px] text-blue-400 hover:underline text-left">View System Prompt</button>
                    </div>
                </div>
                <div class="flex-1 bg-black p-4 overflow-y-auto" id="log-view">
                    <pre class="text-green-500 text-[11px] leading-relaxed whitespace-pre-wrap" x-text="activeAgent.logs"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Start Modal -->
    <div x-show="showStartModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4" x-cloak>
        <div class="bg-gray-800 border border-gray-700 p-6 rounded-xl w-[400px] shadow-2xl">
            <h2 class="text-lg font-bold mb-4 text-blue-400 uppercase tracking-tighter text-center">Deploy Agent</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-gray-500 font-bold mb-1 block uppercase">Callsign</label>
                    <input x-model="startData.agent_name" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm" placeholder="e.g. spider-01">
                </div>
                <div>
                    <label class="text-[10px] text-gray-500 font-bold mb-1 block uppercase">Engine</label>
                    <select x-model="startData.engine" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm">
                        <option value="gemini">Google Gemini (YOLO)</option>
                        <option value="opencode">OpenCode</option>
                        <option value="claude">Claude Native</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button @click="showStartModal = false" class="text-gray-500 text-xs uppercase font-bold">Cancel</button>
                    <button @click="submitStart()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded text-xs font-bold text-white uppercase">Ignite</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Add Task Modal -->
    <div x-show="showAddTask" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4" x-cloak>
        <div class="bg-gray-800 border border-gray-700 p-6 rounded-xl w-96 shadow-2xl">
            <h2 class="text-lg font-bold mb-4 text-blue-400 uppercase tracking-widest text-center">New Mission</h2>
            <div class="space-y-4">
                <input x-model="newTask.id" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm" placeholder="Mission ID (e.g. T1)">
                <textarea x-model="newTask.title" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm h-32" placeholder="Mission Objective..."></textarea>
                <div class="flex justify-end space-x-3">
                    <button @click="showAddTask = false" class="text-gray-500 text-xs font-bold uppercase">Cancel</button>
                    <button @click="submitTask()" class="bg-blue-600 px-4 py-2 rounded text-xs font-bold text-white uppercase tracking-widest shadow-lg">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Prompt Viewer -->
    <div x-show="showPrompt" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/95 p-8" x-cloak>
        <div class="bg-gray-900 border border-blue-900/50 w-full h-full max-w-4xl rounded-xl flex flex-col p-6 shadow-2xl">
            <div class="flex justify-between mb-4 border-b border-gray-800 pb-4">
                <h2 class="text-xl font-black text-blue-500 tracking-tighter uppercase italic">AI Cortex View</h2>
                <button @click="showPrompt = false" class="text-gray-500 hover:text-white transition text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <pre class="text-gray-400 text-sm whitespace-pre-wrap leading-relaxed" x-text="promptContent"></pre>
            </div>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="h-16 border-b border-gray-800 glass flex items-center justify-between px-8 z-20 shadow-2xl">
        <div class="flex items-center space-x-4">
            <div class="px-3 py-1 bg-green-500 text-black rounded font-black text-lg shadow-[0_0_15px_rgba(34,197,94,0.4)]">TT</div>
            <h1 class="tracking-[0.3em] font-black text-gray-300 text-sm">BOARD <span class="text-blue-500 italic">v0.2</span></h1>
        </div>
        <div class="flex items-center space-x-8">
            <div class="text-right">
                <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Economy</p>
                <p class="text-green-400 font-black text-sm" x-text="'$' + stats.total_cost.toFixed(4)"></p>
            </div>
            <button @click="showAddTask = true" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-[10px] font-black tracking-widest transition shadow-lg shadow-blue-900/20 uppercase">+ Task</button>
        </div>
    </nav>

    <main class="flex-1 flex overflow-hidden">
        <!-- Dashboard Left -->
        <div class="flex-1 flex flex-col overflow-hidden p-6 space-y-6">
            
            <section>
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.3em] mb-4 flex items-center">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 shadow-[0_0_8px_rgba(34,197,94,0.8)]"></span> Active Frontline
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="agent in agents" :key="agent">
                        <div @click="openAgentDetail(agent)" class="bg-gray-800 border border-gray-700 p-4 rounded-lg hover:border-blue-500 transition cursor-pointer group shadow-xl relative overflow-hidden">
                            <div class="flex justify-between items-start mb-2 relative z-10">
                                <span class="font-bold text-white group-hover:text-blue-400 transition" x-text="agent"></span>
                                <span class="text-[8px] bg-green-900/30 text-green-400 px-2 py-0.5 rounded border border-green-500/20 font-black uppercase">Live</span>
                            </div>
                            <div class="text-[9px] text-gray-500 uppercase tracking-tighter" x-text="'Engagement: ' + getAgentTaskId(agent)"></div>
                        </div>
                    </template>
                    <div x-show="agents.length === 0" class="col-span-full border-2 border-dashed border-gray-800 rounded-xl py-12 text-center text-gray-600 italic text-sm">
                        Strategic reserve ready. Awaiting orders.
                    </div>
                </div>
            </section>

            <section class="flex-1 flex flex-col min-h-0">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.3em] mb-4">Tactical Backlog</h3>
                <div class="flex-1 bg-gray-800/20 border border-gray-800 rounded-xl overflow-y-auto shadow-inner">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 bg-gray-900 border-b border-gray-800 z-10 shadow-lg">
                            <tr class="text-[9px] text-gray-500 uppercase tracking-widest font-black">
                                <th class="p-4 w-20 text-center">Code</th>
                                <th class="p-4">Mission Objective</th>
                                <th class="p-4 w-32">Engine</th>
                                <th class="p-4 w-32 text-center">Status</th>
                                <th class="p-4 w-40 text-right">Command</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800/50">
                            <template x-for="task in tasks" :key="task.id">
                                <tr class="hover:bg-gray-800/40 transition group">
                                    <td class="p-4 font-black text-blue-500 text-xs text-center" x-text="task.id"></td>
                                    <td class="p-4 text-xs text-gray-300 font-medium" x-text="task.title"></td>
                                    <td class="p-4 text-[9px] text-gray-500 font-black uppercase tracking-tighter" x-text="task.engine || '-'"></td>
                                    <td class="p-4 text-center">
                                        <span class="text-[8px] font-black px-2 py-1 rounded uppercase tracking-tighter" 
                                              :class="{ 'text-yellow-500 bg-yellow-500/10': task.status === 'open', 'text-blue-400 bg-blue-500/10': task.status === 'in_progress', 'text-green-500 bg-green-500/10': task.status === 'closed' }"
                                              x-text="task.status"></span>
                                    </td>
                                    <td class="p-4">
                                        <div class="flex justify-end space-x-2">
                                            <template x-if="task.status === 'open'">
                                                <button @click="openStartModal(task.id)" class="text-[9px] bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded font-black transition uppercase">Start</button>
                                            </template>
                                            <template x-if="task.status === 'in_progress'">
                                                <button @click="markAsDone(task.id)" class="text-[9px] bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded font-black transition uppercase">Done</button>
                                            </template>
                                            <button @click="deleteTask(task.id)" class="text-[9px] bg-red-900/30 hover:bg-red-600 text-red-500 hover:text-white px-2 py-1 rounded font-black transition border border-red-500/20 uppercase">Del</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script>
        function app() {
            return {
                tasks: [], agents: [], logs: [],
                stats: { total_cost: 0, tasks_done: 0, tasks_total: 0 },
                showAgentDetail: false, showAddTask: false, showPrompt: false, showStartModal: false,
                activeAgent: { name: '', taskId: '', logs: '', logPath: '' },
                newTask: { id: '', title: '' },
                startData: { task_id: '', agent_name: '', engine: 'gemini' },
                promptContent: '',
                
                init() {
                    this.refresh();
                    setInterval(() => this.refresh(), 2000);
                },
                async refresh() {
                    try {
                        const res = await fetch('/api/dashboard');
                        const d = await res.json();
                        this.tasks = d.tasks; 
                        this.agents = d.agents; 
                        this.logs = d.recent_logs; 
                        this.stats = d.stats;
                        if (this.showAgentDetail) this.fetchLogs();
                    } catch (e) {}
                },
                getAgentTaskId(name) {
                    const t = this.tasks.find(t => t.assignee === name && t.status === 'in_progress');
                    return t ? t.id : 'N/A';
                },
                async fetchLogs() {
                    if (!this.activeAgent.name || !this.activeAgent.taskId) return;
                    try {
                        const res = await fetch(`/api/logs/${this.activeAgent.taskId}/${this.activeAgent.name}`);
                        const d = await res.json();
                        this.activeAgent.logs = d.content;
                    } catch (e) {}
                },
                async submitTask() {
                    if(!this.newTask.id || !this.newTask.title) return alert("MISSING DATA");
                    await fetch('/api/tasks', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.newTask) });
                    this.showAddTask = false; this.newTask = { id: '', title: '' }; this.refresh();
                },
                openStartModal(tid) {
                    this.startData = { task_id: tid, agent_name: 'coder-' + Math.floor(Math.random()*100), engine: 'gemini' };
                    this.showStartModal = true;
                },
                async submitStart() {
                    await fetch('/api/start', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.startData) });
                    this.showStartModal = false; this.refresh();
                },
                async markAsDone(tid) {
                    if(!confirm("DECOMMISSION AGENT?")) return;
                    await fetch(`/api/done/${tid}`, { method: 'POST' });
                    this.showAgentDetail = false; this.refresh();
                },
                async deleteTask(tid) {
                    if(!confirm("PURGE TASK FROM DATABASE?")) return;
                    await fetch(`/api/tasks/${tid}`, { method: 'DELETE' });
                    this.refresh();
                },
                async nudgeAgent() {
                    const msg = prompt("SIGNAL CONTENT:");
                    if(!msg) return;
                    await fetch('/api/nudge', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ agent_name: this.activeAgent.name, message: msg }) });
                },
                async viewPrompt(role) {
                    const res = await fetch(`/api/prompts/${role}`);
                    const d = await res.json();
                    this.promptContent = d.content;
                    this.showPrompt = true;
                },
                openAgentDetail(name) {
                    const t = this.tasks.find(t => t.assignee === name && t.status === 'in_progress');
                    if(!t) return;
                    this.activeAgent = { name, taskId: t.id, logs: 'Initializing neural link...' };
                    this.showAgentDetail = true; 
                    this.fetchLogs();
                },
                closeModals() { 
                    this.showAgentDetail = false; this.showAddTask = false; 
                    this.showPrompt = false; this.showStartModal = false; 
                },
                formatTime(ts) { 
                    const date = new Date(ts * 1000);
                    return date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0') + ':' + date.getSeconds().toString().padStart(2, '0');
                }
            }
        }
    </script>
</body>
</html>